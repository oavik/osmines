<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>Mines</title>
<style type="text/css">
#game { display: block; margin-left: auto; margin-right: auto; padding: 0; border: 0; }
span { display: inline-block; border-style: solid; border-left-color: #eee; border-top-color: #eee; border-right-color: #333; border-bottom-color: #333; background: #ccc; margin: 0; padding: 0; text-align: center; vertical-align: middle; }
.1 { color: blue; }
.2 { color: red; }
.3 { color: green; }
.4 { color: purple; }
.5 { color: orange; }
.6 { color: yellow; }
.7 { color: white; }
.8 { color: black; }
</style>
<script type="text/javascript">
var game = { width: 10, height: 10, mines: 10, firstclick: true };

function expose(row, col) {
	var square = document.getElementById(row + "-" + col);
	square.style.borderColor = "#ccc";
	square.removeEventListener("click", reveal);
	square.removeEventListener("contextmenu", reveal);

	game.seen[row][col] = true;

	var neighbors = 0;

	for (var i = (row > 1 ? row - 1 : row); i <= (row < game.height - 1 ? row + 1 : row); i++) {
		for (var j = (col > 1 ? col - 1 : col); j <= (col < game.width - 1 ? col + 1 : col); j++) {
				if (game.bombs[i][j]) {
					neighbors++;
				} else if ((i == row || j == col) && !game.seen[i][j]) {
					expose(i, j);
				}
		}
	}

	if (neighbors != 0) {
		square.innerHTML = neighbors;
		square.className = neighbors;
	}
}

function reveal(e) {
	e.preventDefault();
	this.style.borderColor = "#ccc";
	var row = parseInt(this.id);
	var col = parseInt(this.id.substring(this.id.indexOf("-") + 1));
	console.log("click " + row + "," + col);
	console.log(game.bombs[row][col]);

	if (game.firstclick && game.bombs[row][col]) {
		game.bombs[row][col] = false;
		
	}
	game.firstclick = false;

	if (game.bombs[row][col]) {
		this.innerHTML = "&#x1f4a3;";
	} else {
		expose(row, col);
	}
}

function flag(e) {
	e.preventDefault();
	if (this.innerHTML == "&nbsp;") {
		this.innerHTML = "&#x2690;";
		this.removeEventListener("click", reveal);
	} else if (this.innerHTML == "?") {
		this.innerHTML = "";
		this.addEventListener("click", reveal);
	} else {
		this.innerHTML = "?";
	}
}

function resize() {
	var squaresize = Math.floor(Math.min(window.innerWidth / game.width, window.innerHeight / (game.height + 1)));
	var border = Math.ceil(squaresize / 10);
	squaresize -= border * 2;
	var squares = document.getElementsByTagName("span");
	for (var i = 0; i < squares.length; i++) {
		squares[i].style.width = squaresize + "px";
		squares[i].style.height = squaresize + "px";
		squares[i].style.borderWidth = border + "px";
		squares[i].style.fontSize = Math.floor(squaresize * 3 / 4) + "px";
	}
	document.getElementById("game").style.width = (squaresize.width * game.width) + "px";
	document.getElementById("game").style.height = (squaresize.height * game.height) + "px";
}

function init() {
	game.bombs = new Array();
	game.seen = new Array();

	for (var i = 0; i < game.height; i++) {
		game.bombs[i] = new Array();
		game.seen[i] = new Array();
		var row = document.createElement("div");
		for (var j = 0; j < game.width; j++) {
			game.bombs[i][j] = false;
			game.seen[i][j] = false;
			var square = document.createElement("span");
			square.innerHTML = "&nbsp;";
			square.id = i + "-" + j;
			square.addEventListener("click", reveal);
			square.addEventListener("contextmenu", flag);
			row.appendChild(square);
		}
		document.getElementById("game").appendChild(row);
	}

	for (var i = 0; i < game.mines; i++ ) {
		var row = Math.floor(Math.random() * game.height);
		var col = Math.floor(Math.random() * game.width);
		console.log("placing bomb at " + row + "," + col);
		if (game.bombs[row][col]) {
			i--;
		} else {
			game.bombs[row][col] = true;
		}
	}

	resize();
	window.onresize = resize;
}
</script>
</head>
<body onload="init();">
<div id="game"></div>
</body>
</html>
