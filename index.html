<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>Mines</title>
<link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon.png">
<link rel="shortcut icon" type="image/png" href="favicon-32x32.png">
<link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="manifest.json">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">
<style type="text/css">
* { margin: 0; padding: 0; text-align: center; vertical-align: top; }
button { font-size: inherit; }
.n1 { color: blue; }
.n2 { color: green; }
.n3 { color: red; }
.n4 { color: purple; }
.n5 { color: black; }
.n6 { color: maroon; }
.n7 { color: gray; }
.n8 { color: turquoise; }
.bomb { color: black; }
.flag.bomb { color: green ! important; }
.flag { color: red; }
#score { background: #ccc; }
#mines, #time { display: inline-block; }
#options { display: none; color: black; }
#options button { width: 50%; }
label { float: left; }
input[type=number] { float: right; }
input[type=submit] { width: 50%; }
</style>
<script type="text/javascript">
var game = { width: 10, height: 10, mines: 10, firstclick: true };
var icons = {
	bomb: "&#x1f4a3;",
	whiteflag: "&#x2690;",
	blackflag: "&#x1f3f4;",
	happy: "&#x263a;",
	sad: "&#x2639;",
	cool: "&#x1f60e;"
};

function placebomb() {
	while (true) {
		var row = Math.floor(Math.random() * game.height);
		var col = Math.floor(Math.random() * game.width);

		if (!game.bombs[row][col]) {
			game.bombs[row][col] = true;
			break;
		}
	}
}

function expose(row, col) {
	var square = document.getElementById(row + "-" + col);
	square.disabled = true;

	game.seen[row][col] = true;
	game.unclicked--;

	var neighbors = 0;

	for (var i = (row > 0 ? row - 1 : row); i <= (row < game.height - 1 ? row + 1 : row); i++) {
		for (var j = (col > 0 ? col - 1 : col); j <= (col < game.width - 1 ? col + 1 : col); j++) {
			if (game.bombs[i][j]) {
				neighbors++;
			}
		}
	}

	if (neighbors != 0) {
		square.innerHTML = neighbors;
		square.className = "n" + neighbors;
	} else {
		square.innerHTML = "&nbsp;";
		for (var i = (row > 0 ? row - 1 : row); i <= (row < game.height - 1 ? row + 1 : row); i++) {
			for (var j = (col > 0 ? col - 1 : col); j <= (col < game.width - 1 ? col + 1 : col); j++) {
					if (!(i == row && j == col) && !game.seen[i][j] && !game.flagged[i][j] && !game.bombs[i][j]) {
						expose(i, j);
					}
			}
		}
	}
}

function reveal(e) {
	e.preventDefault();

	if (game.timer == undefined) {
		game.timer = window.setInterval(addtime, 1000);
	}

	this.disabled = true;
	var row = parseInt(this.id);
	var col = parseInt(this.id.substring(this.id.indexOf("-") + 1));

	while (game.firstclick && game.bombs[row][col]) {
		game.bombs[row][col] = false;
		placebomb();
	}
	game.firstclick = false;

	if (game.bombs[row][col]) {
		gameover(false);
	} else {
		expose(row, col);
	}
	checkwinner();
}

function flag(e) {
	e.preventDefault();

	var row = parseInt(this.id);
	var col = parseInt(this.id.substring(this.id.indexOf("-") + 1));

	if (game.timer == undefined) {
		game.timer = window.setInterval(addtime, 1000);
	}

	if (game.flagged[row][col]) {
		this.innerHTML = "&nbsp;";
		this.addEventListener("click", reveal);
		game.flagged[row][col] = false;
		game.flags--;
	} else if (game.flags < game.mines) {
		this.innerHTML = icons.whiteflag;
		this.removeEventListener("click", reveal);
		game.flagged[row][col] = true;
		game.flags++;
	}
	document.getElementById("mines").innerHTML = game.mines - game.flags;
	checkwinner();
}

function checkwinner() {
	if (game.unclicked == game.mines) {
		gameover(true);
	}
}

function allsquares(fn) {
	var squares = document.getElementsByTagName("button");
	for (var i = 0; i < squares.length; i++) {
		fn(squares[i]);
	}
}


function resize() {
	console.log("Window width: " + window.innerWidth + "; game width: " + game.width);
	console.log("=" + (window.innerWidth / game.width));
	console.log("Window height: " + window.innerHeight + "; game height: " + game.height);
	console.log("=" + (window.innerHeight / (game.height + 1)));
	var squaresize = Math.floor(Math.min(window.innerWidth / game.width, window.innerHeight / (game.height + 1)));
	console.log("squares: " + squaresize);
	allsquares(function (s) { s.style.width = squaresize + "px"; s.style.height = squaresize + "px"; });

	var controlwidth = (game.width - 1) * squaresize;
	var minessize = Math.floor(controlwidth - squaresize) / 2;
	var timesize = Math.ceil(controlwidth - squaresize) / 2;

	document.getElementById("game").style.width = (controlwidth + squaresize) + "px";
	document.getElementById("game").style.fontSize = Math.floor(squaresize * 3 / 4) + "px";
	document.getElementById("mines").style.width = minessize + "px";
	document.getElementById("time").style.width = timesize + "px";
}

function addtime() {
	game.time++;
	document.getElementById("time").innerHTML = game.time;
}

function disable(s, d) {
	if (d == undefined) {
		d = false;
	}
	s.removeEventListener("click", reveal);
	s.removeEventListener("contextmenu", flag);
	s.disabled = d;
}

function gameover(win) {
	window.clearInterval(game.timer);
	game.timer = undefined;

	for (var i = 0; i < game.height; i++) {
		for (var j = 0; j < game.width; j++) {
			if (game.bombs[i][j]) {
				document.getElementById(i + "-" + j).innerHTML = win ? icons.whiteflag : icons.bomb;
				document.getElementById(i + "-" + j).className += " bomb";
			}

			if (game.flagged[i][j]) {
				document.getElementById(i + "-" + j).innerHTML = icons.blackflag;
				document.getElementById(i + "-" + j).className += " flag";
			} 
		}
	}

	allsquares(disable);
	document.getElementById("newgame").innerHTML = win ?  icons.cool : icons.sad;
}

function newgame() {
	document.getElementById("options").style.display = "none";
	document.getElementById("score").style.visibility = "visible";
	document.getElementById("newgame").style.visibility = "visible";

	game.bombs = new Array();
	game.seen = new Array();
	game.flagged = new Array();
	game.time = 0;
	game.flags = 0;
	game.unclicked = 0;
	game.firstclick = true;

	var rows = document.getElementsByClassName("row");
	for (var i = rows.length-1; i >= 0; i--) {
		console.log("Removing old row");
		rows[i].parentNode.removeChild(rows[i]);
	}
	console.log(document.getElementById("game"));

	for (var i = 0; i < game.height; i++) {
		game.bombs[i] = new Array();
		game.seen[i] = new Array();
		game.flagged[i] = new Array();
		var row = document.createElement("div");
		row.className = "row";
		for (var j = 0; j < game.width; j++) {
			game.bombs[i][j] = false;
			game.seen[i][j] = false;
			game.flagged[i][j] = false;
			var square = document.createElement("button");
			square.innerHTML = "&nbsp;";
			square.id = i + "-" + j;
			square.addEventListener("click", reveal);
			square.addEventListener("contextmenu", flag);
			row.appendChild(square);
			game.unclicked++;
		}
		document.getElementById("game").appendChild(row);
	}

	for (var i = 0; i < game.mines; i++ ) {
		placebomb();
	}

	document.getElementById("mines").innerHTML = game.mines;
	document.getElementById("newgame").innerHTML = icons.happy;
	resize();
}

function selectnewgame(e) {
	var form = document.getElementById("options");
	form.style.width = document.getElementById("game").style.width;
	form.style.display = "block";

	game.oldwidth = game.width;
	game.oldheight = game.height;
	game.oldmines = game.mines;

	document.getElementById("score").style.visibility = "hidden";
	allsquares(function (s) { s.style.visibility = "hidden"; });
}

function oldgame() {
	game.width = game.oldwidth;
	game.height = game.oldheight;
	game.mines = game.oldmines;

	document.getElementById("options").style.display = "none";
	
	document.getElementById("score").style.visibility = "visible";
	allsquares(function (s) { s.style.visibility = "visible"; });
}

function update() {
	var width = document.getElementById("width");
	var height = document.getElementById("height");
	var nmines = document.getElementById("nmines");
	if (isNaN(parseInt(width.value))) {
		width.value = game.width.toString();
	} else if (parseInt(width.value) < 2) {
		width.value = "2";
	} else if (parseInt(width.value) > 99) {
		width.value = "99";
	}

	if (isNaN(parseInt(height.value))) {
		height.value = game.height.toString();
	} else if (parseInt(height.value) < 2) {
		height.value = "2";
	} else if (parseInt(height.value) > 99) {
		height.value = "99";
	}

	if (isNaN(parseInt(nmines.value))) {
		nmines.value = game.nmines.toString();
	} else if (parseInt(nmines.value) < 1) {
		nmines.value = "1";
	} else if (parseInt(nmines.value) > ((width.value * height.value) * 3 / 4)) {
		nmines.value = ((width.value * height.value) * 3 / 4).toString();
	}

	game.width = parseInt(width.value);
	game.height = parseInt(height.value);
	game.mines = parseInt(nmines.value);
}

function init() {
	document.getElementById("newgame").addEventListener("click", selectnewgame);
	/*
	if (localStorage.getItem("width") == undefined) { localStorage.setItem("width", 10); }
	if (localStorage.getItem("height") == undefined) { localStorage.setItem("height", 10); }
	if (localStorage.getItem("mines") == undefined) { localStorage.setItem("mines", 10); }
	game.width = parseInt(localStorage.getItem("width"));
	game.height = parseInt(localStorage.getItem("height"));
	game.mines = parseInt(localStorage.getItem("mines"));
	*/
	newgame();
	window.onresize = resize;
}
</script>
</head>
<body onload="init();">
<div id="game">
	<div id="score">
	<span id="mines"></span>
	<button id="newgame"></button>
	<span id="time">0</span>
	</div>

	<form id="options">
	<label for="width">Width:</label><input type="number" min="2" max="99" id="width" value="10" onchange="update();"><br>
	<label for="height">Height:</label><input type="number" min="2" max="99" id="height" value="10" onchange="update();"><br>
	<label for="nmines">Mines:</label><input type="number" min="1" max="100" id="nmines" value="10" onchange="update();"><br>
	<input type="submit" value="New Game" onclick="newgame(); return false;"><input type="submit" value="Cancel" onclick="oldgame(); return false;">
	</form>

</div>
</body>
</html>
