<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>Mines</title>
<style type="text/css">
#game { display: block; margin-left: auto; margin-right: auto; padding: 0; border: 0; }
span { display: inline-block; border-style: solid; border-left-color: #eee; border-top-color: #eee; border-right-color: #333; border-bottom-color: #333; background: #ccc; margin: 0; padding: 0; text-align: center; vertical-align: middle; }
.n1 { color: blue; }
.n2 { color: green; }
.n3 { color: red; }
.n4 { color: purple; }
.n5 { color: black; }
.n6 { color: maroon; }
.n7 { color: gray; }
.n8 { color: turquoise; }
#score { background: #ccc; }
#mines, #time { display: inline-block; background: #ccc; border-color: #ccc; }
#options { visibility: hidden; background: #ccc; border: thin solid black; position: absolute; top: 10%; left: 10%; }
#options label { width: 10em; }
#options input { width: 3em; }
</style>
<script type="text/javascript">
var game = { width: 10, height: 10, mines: 10, firstclick: true };

/* FIXME: this is missing corner cases, e.g.: */
/* .1 */
/* 11 */
/* Clicking upper-left doesn't reveal lower-right */
function expose(row, col) {
	var square = document.getElementById(row + "-" + col);
	square.style.borderColor = "#ccc";
	square.removeEventListener("click", reveal);
	square.removeEventListener("contextmenu", flag);

	game.seen[row][col] = true;
	game.unclicked--;

	var neighbors = 0;

	for (var i = (row > 0 ? row - 1 : row); i <= (row < game.height - 1 ? row + 1 : row); i++) {
		for (var j = (col > 0 ? col - 1 : col); j <= (col < game.width - 1 ? col + 1 : col); j++) {
				if (game.bombs[i][j]) {
					neighbors++;
				}
		}
	}

	if (neighbors != 0) {
		square.innerHTML = neighbors;
		square.className = "n" + neighbors;
	} else {
		square.innerHTML = "&nbsp;";
		for (var i = (row > 0 ? row - 1 : row); i <= (row < game.height - 1 ? row + 1 : row); i++) {
			for (var j = (col > 0 ? col - 1 : col); j <= (col < game.width - 1 ? col + 1 : col); j++) {
					if ((i == row || j == col) && !game.seen[i][j] && !game.flagged[i][j]) {
						expose(i, j);
					}
			}
		}
	}
}

function reveal(e) {
	e.preventDefault();

	if (game.timer == undefined) {
		game.timer = window.setInterval(addtime, 1000);
	}

	this.style.borderColor = "#ccc";
	var row = parseInt(this.id);
	var col = parseInt(this.id.substring(this.id.indexOf("-") + 1));

	if (game.firstclick && game.bombs[row][col]) {
		game.bombs[row][col] = false;
		var replaced = false;
		while (!replaced) {
			var nrow = Math.floor(Math.random() * game.height);
			var ncol = Math.floor(Math.random() * game.width);
			if (!game.bombs[nrow][ncol]) {
				replaced = true;
				game.bombs[nrow][ncol] = true;
			}
		}
	}

	game.firstclick = false;

	if (game.bombs[row][col]) {
		this.innerHTML = "&#x1f4a3;";
		gameover(false);
	} else {
		expose(row, col);
	}
	checkwinner();
}

function flag(e) {
	e.preventDefault();

	var row = parseInt(this.id);
	var col = parseInt(this.id.substring(this.id.indexOf("-") + 1));

	if (game.timer == undefined) {
		game.timer = window.setInterval(addtime, 1000);
	}

	if (game.flagged[row][col]) {
		this.innerHTML = "&nbsp;";
		this.addEventListener("click", reveal);
		game.flags--;
		game.flagged[row][col] = false;
	} else if (game.flags < game.mines) {
		this.innerHTML = "&#x2690;";
		this.removeEventListener("click", reveal);
		game.flags++;
		game.flagged[row][col] = true;
	}
	document.getElementById("mines").innerHTML = game.mines - game.flags;
	checkwinner();
}

function checkwinner() {
	if (game.unclicked == game.mines) {
		gameover(true);
	}
}

function resize() {
	var squaresize = Math.floor(Math.min(window.innerWidth / game.width, window.innerHeight / (game.height + 1)));
	var border = Math.ceil(squaresize / 20);
	squaresize -= border * 2;
	var squares = document.getElementsByTagName("span");
	for (var i = 0; i < squares.length; i++) {
		squares[i].style.width = squaresize + "px";
		squares[i].style.height = squaresize + "px";
		squares[i].style.borderWidth = border + "px";
		squares[i].style.fontSize = Math.floor(squaresize * 3 / 4) + "px";
	}

	var controlwidth = (game.width - 1) * (squaresize + (2 * border));
	var minessize = Math.floor(controlwidth - squaresize) / 2;
	var timesize = Math.ceil(controlwidth - squaresize) / 2;
	document.getElementById("score").style.width = (controlwidth + squaresize + 2 * border) + "px";
	document.getElementById("mines").style.width = minessize + "px";
	document.getElementById("time").style.width = timesize + "px";
}

function addtime() {
	game.time++;
	document.getElementById("time").innerHTML = game.time;
}

function gameover(win) {
	window.clearInterval(game.timer);
	game.timer = undefined;

	for (var i = 0; i < game.height; i++) {
		for (var j = 0; j < game.width; j++) {
			if (game.flagged[i][j]) {
				document.getElementById(i + "-" + j).innerHTML = "&#x1f3f4;";
				document.getElementById(i + "-" + j).style.color = game.bombs[i][j] ? "green" : "red";
			} else if (game.bombs[i][j]) {
				document.getElementById(i + "-" + j).innerHTML = win ? "&#x2690;" : "&#x1f4a3;";
			}
		}
	}

	document.getElementById("newgame").innerHTML = win ?  "&#x1f60e;" : "&#x2639;";
}

function newgame() {
	document.getElementById("options").style.visibility = "hidden";

	game.bombs = new Array();
	game.seen = new Array();
	game.flagged = new Array();
	game.time = 0;
	game.flags = 0;
	game.unclicked = 0;
	game.firstclick = true;

	var rows = document.getElementsByClassName("row");
	for (var i = rows.length-1; i >= 0; i--) {
		rows[i].parentNode.removeChild(rows[i]);
	}

	for (var i = 0; i < game.height; i++) {
		game.bombs[i] = new Array();
		game.seen[i] = new Array();
		game.flagged[i] = new Array();
		var row = document.createElement("div");
		row.className = "row";
		for (var j = 0; j < game.width; j++) {
			game.bombs[i][j] = false;
			game.seen[i][j] = false;
			game.flagged[i][j] = false;
			var square = document.createElement("span");
			square.innerHTML = "&nbsp;";
			square.id = i + "-" + j;
			square.addEventListener("click", reveal);
			square.addEventListener("contextmenu", flag);
			row.appendChild(square);
			game.unclicked++;
		}
		document.getElementById("game").appendChild(row);
	}

	for (var i = 0; i < game.mines; i++ ) {
		var row = Math.floor(Math.random() * game.height);
		var col = Math.floor(Math.random() * game.width);

		if (game.bombs[row][col]) {
			i--;
		} else {
			game.bombs[row][col] = true;
		}
	}

	document.getElementById("mines").innerHTML = game.mines;
	document.getElementById("newgame").innerHTML = "&#x263a";
	resize();
}

function options(e) {
	e.preventDefault();

	document.getElementById("options").style.visibility = "visible";
}

function update() {
	var width = document.getElementById("width");
	var height = document.getElementById("height");
	var nmines = document.getElementById("nmines");
	if (isNaN(parseInt(width.value))) {
		width.value = game.width.toString();
	} else if (parseInt(width.value) < 2) {
		width.value = "2";
	} else if (parseInt(width.value) > 99) {
		width.value = "99";
	}

	if (isNaN(parseInt(height.value))) {
		height.value = game.height.toString();
	} else if (parseInt(height.value) < 2) {
		height.value = "2";
	} else if (parseInt(height.value) > 99) {
		height.value = "99";
	}

	if (isNaN(parseInt(nmines.value))) {
		nmines.value = game.nmines.toString();
	} else if (parseInt(nmines.value) < 1) {
		nmines.value = "1";
	} else if (parseInt(nmines.value) > ((width.value * height.value) * 3 / 4)) {
		nmines.value = ((width.value * height.value) * 3 / 4).toString();
	}

	game.width = width.value;
	game.height = height.value;
	game.mines = nmines.value;
}

function init() {
	document.getElementById("newgame").addEventListener("click", newgame);
	document.getElementById("newgame").addEventListener("contextmenu", options);
	/*
	if (localStorage.getItem("width") == undefined) { localStorage.setItem("width", 10); }
	if (localStorage.getItem("height") == undefined) { localStorage.setItem("height", 10); }
	if (localStorage.getItem("mines") == undefined) { localStorage.setItem("mines", 10); }
	game.width = parseInt(localStorage.getItem("width"));
	game.height = parseInt(localStorage.getItem("height"));
	game.mines = parseInt(localStorage.getItem("mines"));
	*/
	newgame();
	window.onresize = resize;
}
</script>
</head>
<body onload="init();">
<div id="game">
	<div id="score">
	<span id="mines">0</span>
	<span id="newgame">&#x263a;</span>
	<span id="time">0</span>
	</div>
</div>
<div id="options">
	<form action="#" onsubmit="newgame();">
	<div><label for="width">Width:</label><input type="number" min="2" max="99" id="width" value="10" onchange="update();"></div>
	<div><label for="height">Height:</label><input type="number" min="2" max="99" id="height" value="10" onchange="update();"></div>
	<div><label for="nmines">Mines:</label><input type="number" min="1" max="100" id="nmines" value="10" onchange="update();"></div>
	</form>
</div>
</body>
</html>
